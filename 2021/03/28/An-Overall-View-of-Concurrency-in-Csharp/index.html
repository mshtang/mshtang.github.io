<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="keywords" content="Hexo Theme Keep"><meta name="description" content="I share what I have at hand or in mind"><meta name="author" content="mshtang"><title>An Overall View of Concurrency in C# | Mao&#39;s Noland</title><link rel="stylesheet" href="/css/style.css"><link rel="shortcut icon" href="/images/mylogo.svg"><link rel="stylesheet" href="/css/font-awesome.min.css"><script id="hexo-configurations">let KEEP=window.KEEP||{};KEEP.hexo_config={hostname:"mshtang.github.io",root:"/",language:"en",path:"search.json"},KEEP.theme_config={toc:{enable:!0,number:!0,expand_all:!1,init_open:!1},style:{primary_color:"#0066CC",avatar:"/images/mylogo.svg",favicon:"/images/mylogo.svg",article_img_align:"center",left_side_width:"260px",content_max_width:"920px",hover:{shadow:!1,scale:!1},first_screen:{enable:!0,background_img:"/images/bg.svg",description:"I share what I have in mind or hand."},scroll:{progress_bar:{enable:!0},percent:{enable:!1}}},local_search:{enable:!0,preload:!1},code_copy:{enable:!1,style:"default"},pjax:{enable:!0},lazyload:{enable:!0},version:"3.4.3"},KEEP.language_ago={second:"%s seconds ago",minute:"%s minutes ago",hour:"%s hours ago",day:"%s days ago",week:"%s weeks ago",month:"%s months ago",year:"%s years ago"}</script><meta name="generator" content="Hexo 6.2.0"></head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span> <span class="pjax-progress-icon"><i class="fas fa-circle-notch fa-spin"></i></span></div><main class="page-container"><div class="page-main-content"><div class="page-main-content-top"><header class="header-wrapper"><div class="header-content"><div class="left"><a class="logo-image" href="/"><img src="/images/mylogo.svg"> </a><a class="logo-title" href="/">Mao&#39;s Noland</a></div><div class="right"><div class="pc"><ul class="menu-list"><li class="menu-item"><a href="/">HOME</a></li><li class="menu-item"><a href="/archives">ARCHIVES</a></li><li class="menu-item"><a href="/categories">CATEGORIES</a></li><li class="menu-item"><a href="/about">ABOUT</a></li><li class="menu-item search search-popup-trigger"><i class="fas fa-search"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div><div class="icon-item menu-bar"><div class="menu-bar-middle"></div></div></div></div></div><div class="header-drawer"><ul class="drawer-menu-list"><li class="drawer-menu-item flex-center"><a href="/">HOME</a></li><li class="drawer-menu-item flex-center"><a href="/archives">ARCHIVES</a></li><li class="drawer-menu-item flex-center"><a href="/categories">CATEGORIES</a></li><li class="drawer-menu-item flex-center"><a href="/about">ABOUT</a></li></ul></div><div class="window-mask"></div></header></div><div class="page-main-content-middle"><div class="main-content"><div class="fade-in-down-animation"><div class="article-content-container"><div class="article-title"><span class="title-hover-animation">An Overall View of Concurrency in C#</span></div><div class="article-header"><div class="avatar"><img src="/images/mylogo.svg"></div><div class="info"><div class="author"><span class="name">mshtang</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fas fa-edit"></i>&nbsp; <span class="pc">2021-03-28 13:04:18</span> <span class="mobile">2021-03-28 13:04</span> </span><span class="article-categories article-meta-item"><i class="fas fa-folder"></i>&nbsp;<ul><li><a href="/categories/Programming/">Programming</a>&nbsp;</li><li>&gt; <a href="/categories/Books/">Books</a>&nbsp;</li><li>&gt; <a href="/categories/Books/Concurrency-in-C-Cookbook/">Concurrency in C# Cookbook</a>&nbsp;</li></ul></span><span class="article-tags article-meta-item"><i class="fas fa-tags"></i>&nbsp;<ul><li><a href="/tags/C/">C#</a>&nbsp;</li></ul></span></div></div></div></div><div class="article-content markdown-body"><p>This article is <strong>largely</strong> excerpted from the “Concurrency in C# Cookbook” by Stephen Cleary.</p><h1 id="Introduction-to-Concurrency"><a href="#Introduction-to-Concurrency" class="headerlink" title="Introduction to Concurrency"></a>Introduction to Concurrency</h1><p><strong>Concurrency</strong>: Doing more than one thing at a time<br><strong>Multithreading</strong>: A form of concurrency that uses multiple threads of execution</p><p><strong>Parallel processing</strong>: Doing lots of work by dividing it up among multiple threads that run concurrently</p><blockquote><p>Parallel processing is one type of multithreading, and multithreading is one type of concurrency.</p></blockquote><p><strong>Asynchronous programming</strong>: A form of concurrency that uses futures or callbacks to avoid unnecessary threads</p><p><strong>Reactive programming</strong>: A declarative style of programming where the application reacts to events</p><h1 id="Introduction-to-Asynchronous-Programming"><a href="#Introduction-to-Asynchronous-Programming" class="headerlink" title="Introduction to Asynchronous Programming"></a>Introduction to Asynchronous Programming</h1><p>The core of async programming is the <code>Task</code> and <code>Task&lt;T&gt;</code> objects, which model asynchronous operations. They are supported by the <code>async</code> and <code>await</code> keywords. The model is fairly simple in most cases:</p><ul><li><p>For I&#x2F;O-bound code, you await an operation that returns a <code>Task</code> or <code>Task&lt;T&gt;</code> inside of an async method.</p></li><li><p>For CPU-bound code, you await an operation that is started on a background thread with the <code>Task.Run</code> method.</p></li></ul><h2 id="Recognize-CPU-bound-and-I-x2F-O-bound-work"><a href="#Recognize-CPU-bound-and-I-x2F-O-bound-work" class="headerlink" title="Recognize CPU-bound and I&#x2F;O-bound work"></a>Recognize CPU-bound and I&#x2F;O-bound work</h2><p>Here are two questions you should ask before you write any code:</p><ol><li><p>Will your code be “waiting” for something, such as data from a database? If your answer is “yes”, then your work is I&#x2F;O-bound.</p></li><li><p>Will your code be performing an expensive computation? If you answered “yes”, then your work is CPU-bound.</p></li></ol><p>If the work you have is I&#x2F;O-bound, use <code>async</code> and <code>await</code> without <code>Task.Run</code>. You <em><strong>should not</strong></em> use the Task Parallel Library.</p><p>If the work you have is CPU-bound and you care about responsiveness, use <code>async</code> and <code>await</code>, but spawn off the work on another thread with <code>Task.Run</code>. If the work is appropriate for concurrency and parallelism, also consider using the Task Parallel Library.</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">async</span> Task <span class="title">DoSomethingAsync</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">value</span> = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Asynchronously wait 1 second.</span></span><br><span class="line">  <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">value</span> *= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Asynchronously wait 1 second.</span></span><br><span class="line">  <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">  Trace.WriteLine(<span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>You can think of an <code>async</code> method as having several synchronous portions, broken up by <code>await</code> statements. The first synchronous portion executes on whatever thread calls the method, but where do the other synchronous portions execute? The answer is a bit complicated.</p><p>When you <code>await</code> a task (the most common scenario), a context is captured when the <code>await</code> decides to pause the method. This is the current <code>SynchronizationContext</code> unless it’s <code>null</code>, in which case the context is the current <code>TaskScheduler</code>. The method resumes executing within that captured context. Usually, this context is the UI context (if you’re on the UI thread) or the threadpool context (most other situations).</p><p>So, in the preceding code, all the synchronous portions will attempt to resume on the original context. If you call <code>DoSomethingAsync</code> from a UI thread, each of its synchronous portions will run on that UI thread; but if you call it from a threadpool thread, each of its synchronous portions will run on any threadpool thread.</p><p>You can avoid this default behavior by awaiting the result of the <code>ConfigureAwait</code> extension method and passing <code>false</code> for the <code>continueOnCapturedContext</code> parameter. The following code will start on the calling thread, and after it is paused by an <code>await</code>, it’ll resume on a threadpool thread:</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">async</span> Task <span class="title">DoSomethingAsync</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> <span class="keyword">value</span> = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Asynchronously wait 1 second.</span></span><br><span class="line">  <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">1</span>)).ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">value</span> *= <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Asynchronously wait 1 second.</span></span><br><span class="line">  <span class="keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="number">1</span>)).ConfigureAwait(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  Trace.WriteLine(<span class="keyword">value</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>It’s good practice to always call <code>ConfigureAwait(false)</code> in your core “library” methods, and only resume the context when you need it—in your outer “user interface” methods.</p></blockquote><blockquote><p>it’s also a good idea to be aware of context when writing <code>async</code> code. Normally, an <code>async</code> method should <em>either</em> require context (dealing with UI elements or ASP.NET requests&#x2F;response) <em>or</em> be free from context (doing background operations). If you have an <code>async</code> method that has parts requiring context and parts free from context, consider splitting up into two (or more) <code>async</code> methods.</p></blockquote><blockquote><p>Once you start using async, it’s best to allow it to grow through your code. If you call an <code>async</code> method, you should (eventually) <code>await</code> the task it returns. Resist the temptation to call <code>Task.Wait</code>, <code>Task&lt;TResult&gt;.Result</code>, or <code>GetAwaiter().GetResult()</code>; doing so could cause a deadlock.</p></blockquote><h1 id="Introduction-to-Parallel-Programming"><a href="#Introduction-to-Parallel-Programming" class="headerlink" title="Introduction to Parallel Programming"></a>Introduction to Parallel Programming</h1><p>Parallel programming should be used any time you have a fair amount of computation work that can be split up into independent chunks. Parallel programming increases the CPU usage temporarily to improve throughput; this is desirable on client systems where CPUs are often idle, but it’s usually not appropriate for server systems. Parallel programming on the server would work against its built-in parallelism and therefore wouldn’t provide any real benefit.</p><p>There are two forms of parallelism: <em>data parallelism</em> and <em>task parallelism</em>. Data parallelism is when you have a bunch of data items to process, and the processing of each piece of data is mostly independent from the other pieces. Task parallelism is when you have a pool of work to do, and each piece of work is mostly independent from the other pieces. Task parallelism may be dynamic; if one piece of work results in several additional pieces of work, they can be added to the pool of work.</p><p>To do data parallelism, use <code>Parallel.ForEach</code> (<code>Parallel.For</code>) or PLINQ, which provides an <code>AsParallel</code> extension method for LINQ queries.<br>To do task parallelism, use <code>Parallel.Invoke</code>, which is one type of <code>Parallel</code> method that does a kind of fork&#x2F;join task parallelism.</p><blockquote><p>One difference between <code>Parallel</code> and PLINQ is that PLINQ assumes it can use all the cores on the computer, while <code>Parallel</code> will dynamically react to changing CPU conditions.</p></blockquote><p>Data parallelism is focused on processing data; task parallelism is just about doing work. At a high level, data parallelism and task parallelism are similar; “processing data” is a kind of “work.” Many parallelism problems can be solved either way; it’s convenient to use whichever API is more natural for the problem at hand.</p><blockquote><p>The chunks of work should be as independent from one another as possible when using parallel programming.</p></blockquote><blockquote><p>Tasks should neither be extremely short nor extremely long.</p></blockquote><h1 id="Modern-Design"><a href="#Modern-Design" class="headerlink" title="Modern Design"></a>Modern Design</h1><p>Most concurrent technologies have one similar aspect: they are functional in nature.</p><p>One principle of functional programming is <strong>purity</strong> (that is, avoiding side effects). Each piece of the solution takes some value(s) as input and produces some value(s) as output. As much as possible, you should avoid having these pieces depend on global (or shared) variables or update global (or shared) data structures. This is true whether the piece is an async method, a parallel task, a System.Reactive operation, or a dataflow block.</p></div><ul class="post-tags-box"><li class="tag-item"><a href="/tags/C/">#C#</a>&nbsp;</li></ul><div class="article-nav"><div class="article-prev"><a class="prev" rel="prev" href="/2021/04/04/Express-Timeout-with-Cancellation/"><span class="left arrow-icon flex-center"><i class="fas fa-chevron-left"></i> </span><span class="title flex-center"><span class="post-nav-title-item">Express Timeout with Cancellation</span> <span class="post-nav-item">Prev posts</span></span></a></div><div class="article-next"><a class="next" rel="next" href="/2020/04/07/hello-world/"><span class="title flex-center"><span class="post-nav-title-item">Hexo Quick Start Reference</span> <span class="post-nav-item">Next posts</span> </span><span class="right arrow-icon flex-center"><i class="fas fa-chevron-right"></i></span></a></div></div></div></div></div></div><div class="page-main-content-bottom"><footer class="footer"><div class="info-container"><div class="copyright-info info-item">&copy; <span>2020</span> - 2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">mshtang</a></div><div class="theme-info info-item">Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a></div></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="tools-list"><li class="tools-item page-aside-toggle"><i class="fas fa-outdent"></i></li></ul></div></div><div class="right-bottom-side-tools"><div class="side-tools-container"><ul class="side-tools-list"><li class="tools-item tool-font-adjust-plus flex-center"><i class="fas fa-search-plus"></i></li><li class="tools-item tool-font-adjust-minus flex-center"><i class="fas fa-search-minus"></i></li><li class="tools-item tool-expand-width flex-center"><i class="fas fa-arrows-alt-h"></i></li><li class="tools-item tool-dark-light-toggle flex-center"><i class="fas fa-moon"></i></li><li class="tools-item tool-scroll-to-top flex-center"><i class="fas fa-arrow-up"></i></li><li class="tools-item tool-scroll-to-bottom flex-center"><i class="fas fa-arrow-down"></i></li></ul><ul class="exposed-tools-list"><li class="tools-item tool-toggle-show flex-center"><i class="fas fa-cog fa-spin"></i></li></ul></div></div><aside class="page-aside"><div class="post-toc-wrap"><div class="post-toc"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction-to-Concurrency"><span class="nav-number">1.</span> <span class="nav-text">Introduction to Concurrency</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction-to-Asynchronous-Programming"><span class="nav-number">2.</span> <span class="nav-text">Introduction to Asynchronous Programming</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Recognize-CPU-bound-and-I-x2F-O-bound-work"><span class="nav-number">2.1.</span> <span class="nav-text">Recognize CPU-bound and I&#x2F;O-bound work</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction-to-Parallel-Programming"><span class="nav-number">3.</span> <span class="nav-text">Introduction to Parallel Programming</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Modern-Design"><span class="nav-number">4.</span> <span class="nav-text">Modern Design</span></a></li></ol></div></div></aside><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fas fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fas fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/header-shrink.js"></script><script src="/js/back2top.js"></script><script src="/js/dark-light-toggle.js"></script><script src="/js/local-search.js"></script><script src="/js/lazyload.js"></script><div class="post-scripts pjax"><script src="/js/left-side-toggle.js"></script><script src="/js/libs/anime.min.js"></script><script src="/js/toc.js"></script></div><script src="/js/libs/pjax.min.js"></script><script>window.addEventListener("DOMContentLoaded",()=>{window.pjax=new Pjax({selectors:["head title",".page-container",".pjax"],history:!0,debug:!1,cacheBust:!1,timeout:0,analytics:!1,currentUrlFullReload:!1,scrollRestoration:!1}),document.addEventListener("pjax:send",()=>{KEEP.utils.pjaxProgressBarStart()}),document.addEventListener("pjax:complete",()=>{KEEP.utils.pjaxProgressBarEnd(),window.pjax.executeScripts(document.querySelectorAll("script[data-pjax], .pjax script")),KEEP.refresh()})})</script></body></html>